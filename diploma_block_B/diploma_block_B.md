# Курсовая работа блока B "Сделки и деньги"

## Описание задачи
Развить созданную конфигурацию "Управление ИТ-фирмой", обеспечив возможность учета хозяйственных операций по приобретению и реализации товаров и услуг и движению денежных средств с базовым механизмом ценообразования и набором простых отчетов.

## Результат [Выгрузка ИБ](https://github.com/MikeMadudin/onec_diploma/blob/main/diploma_block_B/%D0%92%D1%8B%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0%D0%94%D0%B8%D0%BF%D0%BB%D0%BE%D0%BC%D0%91%D0%BB%D0%BE%D0%BAB.dt)

## Реализовано:
__Документы__:
- Документ `УстановкаЦен`:
    - форма с выбором и подбором номенклатуры с автоматическим назначением цен согласно срезу последних регистра сведений Цены.
    - движения в регистр сведений Цены.
- Документ `УстановкаСкидок`:
    - форма с выбором номенклатуры и номенклатурных групп с автоматическим назначением скидок согласно срезу последних регистра сведений Скидки.
    - движения в регистр сведений Скидки.
- Документ `ПоступлениеТоваровИУслуг`:
    - форма с выбором и подбором номенклатуры с автоматическим пересчетом числовых колонок по правилам:
      - при изменении реквизитов Количество и Цена пересчитывается Сумма и СуммаНДС.
      - при изменении реквизита Сумма пересчитывается Цена и СуммаНДС.
      - при изменении реквизита СтавкаНДС пересчитывается СуммаНДС.
    - перед записью заполняет реквизит шапки Сумма итогом по одноименной колонке табличной части.
    - документ формирует движения:
      - расход по регистру накопления ВзаиморасчетыСКонтрагентами с указанием поставщика в сумме общего итога по реквизиту ТЧ Сумма.
      - приход по регистру накопления Товары в разрезе номенклатуры типа Товар согласно реквизитам ТЧ Количество и Сумма.
      - по регистру накопления Расходы в разрезе номенклатуры типа Услуга согласно реквизиту ТЧ Сумма.
- Документ `РеализацияТоваровИУслуг`:
    - форма с выбором и подбором номенклатуры с автоматическим назначением цены и скидки, а также пересчетом числовых колонок по правилам:
      - при изменении реквизитов Количество и Цена пересчитывается Сумма (с учетом скидки) и СуммаНДС.
      - при изменении реквизита Скидка пересчитывается Сумма и СуммаНДС.
      - при изменении реквизита Сумма пересчитывается СуммаНДС.
      - при изменении реквизита СтавкаНДС пересчитывается СуммаНДС.
    - перед записью заполняет реквизит шапки Сумма итогом по одноименной колонке табличной части
    - документ формирует движения:
      - приход по регистру накопления ВзаиморасчетыСКонтрагентами с указанием покупателя в сумме общего итога по реквизиту ТЧ Сумма.
      - расход по регистру накопления Товары в разрезе номенклатуры типа Товар согласно реквизиту ТЧ Количество и сумме, определенной согласно средней стоимости остатков этого товара. В отсутствие достаточного остатка проведение не выполняется.
      - по регистру накопления Расходы в разрезе номенклатуры типа Товар в сумме себестоимости продаж.
      - по регистру накопления Доходы в разрезе номенклатуры всех типов согласно реквизиту ТЧ Сумма.
- Документ `ПоступлениеДенежныхСредств`:
    - формирует движения расход в регистр накопления ВзаиморасчетыСКонтрагентами с указанием плательщика и суммы.
- Документ `СписаниеДенежныхСредств`:
    - формирует движения приход в регистр накопления ВзаиморасчетыСКонтрагентами с указанием получателя и суммы.

__Регистры__:
- Регистр накопления `ВзаиморасчетыСКонтрагентами`:
    - вид Остатки
    - измерение Контрагент, ресурс Сумма
- Регистр накопления `Товары`:
    - вид Остатки
    - измерение Номенклатура, ресурсы Количество и Сумма
    - хранит текущие остатки товаров и их себестоимость с учетом НДС
- Регистр накопления `Доходы`:
    - вид Обороты
    - измерение Номенклатура, ресурсы Количество и Сумма
    - хранит доходы от реализации товаров и услуг с учетом НДС
- Регистр накопления `Расходы`:
    - вид Обороты
    - измерение Номенклатура, ресурсы Количество и Сумма
    - хранит расходы по приобретенным услугам и себестоимость реализованных товаров с учетом НДС

__Отчеты__:
- Отчет `ДоходыИРасходы`:
    - выводит, соединяя, данные регистров Доходы и Расходы в три колонки ("Доходы", "Расходы", "Прибыль")
    - содержит группировку по номенклатуре с учетом иерархии и общие итоги
- Отчет `ДвижениеТоваров`:
    - выводит данные регистра Товары: остатки и обороты по количеству и сумме
    - содержит группировку по номенклатуре с учетом иерархии и общие итоги
    - не суммирует количества в общем итоге и по иерархии номенклатуры
- Отчет `ВзаиморасчетыСКонтрагентами`:
    - выводит данные регистра ВзаиморасчетыСКонтрагентами: остатки и обороты
    - содержит группировку по контрагентам и общие итоги

__Функции__:

Применение скидок:
```bsl
Функция СкидкаНаДату(Номенклатура, Дата, Скидка) Экспорт
	
	Запрос = Новый Запрос;
	// С помощью временных таблиц получаем скидки по Номенклатуре и НомеклатурнойГруппе на дату документа
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка = &Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнаяГруппа КАК Номенклатура,
		|	СкидкиСрезПоследних.Скидка КАК Скидка
		|ПОМЕСТИТЬ ВТ_СкидкиПоНоменклатуре
		|ИЗ
		|	РегистрСведений.Скидки.СрезПоследних(
		|			&Дата,
		|			НоменклатураНоменклатурнаяГруппа В
		|				(ВЫБРАТЬ
		|					ВТ_Товары.Номенклатура КАК Номенклатура
		|				ИЗ
		|					ВТ_Товары КАК ВТ_Товары)) КАК СкидкиСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
		|	СкидкиСрезПоследних.Скидка КАК Скидка
		|ПОМЕСТИТЬ ВТ_СкидкиПоГруппеНоменклатуры
		|ИЗ
		|	РегистрСведений.Скидки.СрезПоследних(
		|			&Дата,
		|			НоменклатураНоменклатурнаяГруппа В
		|				(ВЫБРАТЬ
		|					ВТ_Товары.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа
		|				ИЗ
		|					ВТ_Товары КАК ВТ_Товары)) КАК СкидкиСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ВТ_СкидкиПоНоменклатуре.Скидка КАК СкидкаПоНоменклатуре,
		|	ВТ_СкидкиПоГруппеНоменклатуры.Скидка КАК СкидкаПоНоменклатурнойГруппе
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СкидкиПоНоменклатуре КАК ВТ_СкидкиПоНоменклатуре
		|		ПО ВТ_Товары.Номенклатура = ВТ_СкидкиПоНоменклатуре.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СкидкиПоГруппеНоменклатуры КАК ВТ_СкидкиПоГруппеНоменклатуры
		|		ПО ВТ_Товары.НоменклатурнаяГруппа = ВТ_СкидкиПоГруппеНоменклатуры.НоменклатурнаяГруппа";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Истина;		
	КонецЕсли;
	
	РезультатТаблицаЗначений = РезультатЗапроса.Выгрузить();
	
	Для каждого СтрокаТаблицы Из РезультатТаблицаЗначений Цикл
		// Если присутствуют скидки и по Номенклатуре и по ГруппеНоменклатуры, тогда в возвращаем скидку по Номенклатуре
		Если ЗначениеЗаполнено(СтрокаТаблицы.СкидкаПоНоменклатуре) И ЗначениеЗаполнено(СтрокаТаблицы.СкидкаПоНоменклатурнойГруппе) Тогда
			Скидка = СтрокаТаблицы.СкидкаПоНоменклатуре;
			Возврат Скидка;
		ИначеЕсли Не ЗначениеЗаполнено(СтрокаТаблицы.СкидкаПоНоменклатуре) И ЗначениеЗаполнено(СтрокаТаблицы.СкидкаПоНоменклатурнойГруппе) Тогда
			Скидка = СтрокаТаблицы.СкидкаПоНоменклатурнойГруппе; 
			Возврат Скидка;
		Иначе
			Скидка = СтрокаТаблицы.СкидкаПоНоменклатуре;
			Возврат Скидка;	
		КонецЕсли;
		
	КонецЦикла;
	
 КонецФункции
```

Цены:
```bsl
Функция ЦенаНаДату(Номенклатура, Дата, Цена) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЦеныСрезПоследних.Номенклатура КАК Номенклатура,
		|	ЦеныСрезПоследних.Цена КАК Цена
		|ИЗ
		|	РегистрСведений.Цены.СрезПоследних(&Дата, Номенклатура.Ссылка = Номенклатура) КАК ЦеныСрезПоследних";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.Номенклатура = Номенклатура Тогда
			Цена = Выборка.Цена;
			Возврат Цена;
		Иначе
			Цена = 0;
		КонецЕсли;		
	КонецЦикла;

КонецФункции
```

Расчет НДС:
```bsl
Функция СуммаНДСПоСтавке(ИзмененнаяСтрока) Экспорт
	
	Если ИзмененнаяСтрока.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.НДС20") Тогда
		
		ИзмененнаяСтрока.СуммаНДС = ИзмененнаяСтрока.Сумма * 0.2 / (1 + 0.2);
		Возврат ИзмененнаяСтрока;
		
	ИначеЕсли ИзмененнаяСтрока.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.НДС10") Тогда
		
		ИзмененнаяСтрока.СуммаНДС = ИзмененнаяСтрока.Сумма * 0.1 / (1 + 0.1);
		Возврат ИзмененнаяСтрока;
		
	ИначеЕсли ИзмененнаяСтрока.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.БезНДС") Тогда
		
		ИзмененнаяСтрока.СуммаНДС = 0;
		Возврат ИзмененнаяСтрока;
		
	КонецЕсли;		

КонецФункции
```
